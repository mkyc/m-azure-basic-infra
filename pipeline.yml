trigger:
  - develop
  - master
pr:
  - develop
  - master

pool:
  name: $(poolName)

steps:
  - task: Bash@3
    displayName: 'Set Build Variables'
    inputs:
      targetType: 'inline'
      script: |
        echo "##vso[task.setvariable variable=MAJOR_VERSION]$(make print-VERSION)"
        echo "##vso[task.setvariable variable=IMAGE_NAME]$(make print-IMAGE_NAME)"
        echo "##vso[task.setvariable variable=IMAGE_REPOSITORY]$(make print-IMAGE_REPOSITORY)"
  - task: GoTool@0
    displayName: 'ensure Go 1.15.2'
    inputs:
      version: '1.15.2'
  - task: Bash@3
    displayName: 'Prepend PATH'
    inputs:
      targetType: 'inline'
      script: |
        echo "##vso[task.prependpath]/tools/go/1.15.2/x64/bin"
      failOnStderr: true
  - task: Go@0
    displayName: 'go get go-junit-report'
    inputs:
      command: get
      arguments: '-u github.com/jstemmer/go-junit-report'
  - task: Go@0
    displayName: 'go get govvv'
    inputs:
      command: get
      arguments: '-u github.com/ahmetb/govvv'
  - task: Bash@3
    displayName: 'go test'
    inputs:
      targetType: 'inline'
      script: |
        go env
        make build
        make pipeline-test | tee tests.output
        go-junit-report < tests.output > report.xml
        docker tag $(IMAGE_REPOSITORY):$(MAJOR_VERSION) $(registry_name)/$(IMAGE_REPOSITORY):$(MAJOR_VERSION).$(Build.BuildId)
      failOnStderr: true
    env:
      K8S_VOL_PATH: '/tmp/tests-share'
      K8S_HOST_PATH: '/tests-share'
      CGO_ENABLED: 0
      AZURE_CLIENT_ID: $(clientId)
      AZURE_CLIENT_SECRET: $(clientSecret)
      AZURE_SUBSCRIPTION_ID: $(subscriptionId)
      AZURE_TENANT_ID: $(tenantId)
      VERSION: $(MAJOR_VERSION)
      GOBIN: "/tools/go/1.15.2/x64/bin"
  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: $(System.DefaultWorkingDirectory)/**/report.xml
      failTaskOnFailedTests: true
  - task: Docker@2
    displayName: 'Push Image'
    inputs:
      containerRegistry: $(registry_name)
      command: push
      repository: $(IMAGE_REPOSITORY)
      tags: $(MAJOR_VERSION).$(Build.BuildId)
